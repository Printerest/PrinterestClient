<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printerest - Upload Document</title>
<link rel="icon" type="image/x-icon" href="ICON.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- PDF.js Library for reading PDF pages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #054089;
            --primary-light: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #f8fafc;
            --accent-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            --sidebar-width: 280px;
            --sidebar-width-collapsed: 80px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--secondary-color);
            overflow-x: hidden;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            display: none;
        }

        .mobile-menu-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .sidebar-logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-logo-text {
            opacity: 0;
            width: 0;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--secondary-color);
            color: var(--primary-color);
        }

        .sidebar-nav {
            padding: 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        .nav-link-text {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-link-text {
            opacity: 0;
            width: 0;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
        }

        .sidebar-user {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: white;
        }

        /* E-wallet Display Styles */
        .wallet-display {
            background: linear-gradient(135deg, var(--accent-color), #059669);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            color: white;
            text-align: center;
            transition: all 0.3s ease;
        }

        .wallet-title {
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .wallet-amount {
            font-size: 1.25rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .wallet-icon {
            font-size: 1rem;
        }

        .sidebar.collapsed .wallet-display {
            padding: 0.75rem 0.5rem;
        }

        .sidebar.collapsed .wallet-title {
            display: none;
        }

        .sidebar.collapsed .wallet-amount {
            font-size: 1rem;
        }

        /* Logout Button Styles */
        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 2px solid var(--error-color);
            border-radius: 0.5rem;
            color: var(--error-color);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            margin-top: 0.75rem;
        }

        .logout-btn:hover {
            background: var(--error-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .sidebar.collapsed .logout-btn {
            padding: 0.75rem 0.5rem;
        }

        .sidebar.collapsed .logout-btn-text {
            display: none;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: var(--secondary-color);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            transition: opacity 0.3s ease;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.2;
            word-wrap: break-word;
            white-space: normal;
        }

        .user-role {
            color: var(--text-secondary);
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar.collapsed .user-info {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            padding: 2rem;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-width-collapsed);
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 50%, var(--accent-color) 100%);
            padding: 4rem 2rem;
            margin: -2rem -2rem 3rem -2rem;
            border-radius: 0 0 2rem 2rem;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .hero-subtitle {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        .hero-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .feature-item i {
            font-size: 1.25rem;
        }

        .feature-item span {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Upload Container */
        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            padding: 3rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(5, 64, 137, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--text-primary);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 64, 137, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Payment Method Selection */
        .payment-method-section {
            background: var(--secondary-color);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
        }

        .payment-method-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .payment-method:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .payment-method.selected {
            border-color: var(--accent-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .payment-method-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .payment-method.cash .payment-method-icon {
            color: #10b981;
        }

        .payment-method.g-cash .payment-method-icon {
            color: #0066cc;
        }

        .payment-method-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .payment-method-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .payment-method-radio {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 20px;
            height: 20px;
        }

        /* E-wallet Notice */
        .cash-notice {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #059669;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }

        .cash-notice.show {
            display: block;
        }

        .cash-notice i {
            margin-right: 0.5rem;
        }

        /* File List */
        #fileList {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--secondary-color);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .file-item.processing {
            opacity: 0.7;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            color: var(--primary-color);
            font-size: 1.25rem;
        }

        .file-details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            gap: 1rem;
            margin-top: 0.25rem;
        }

        .file-pages {
            font-weight: 500;
            color: var(--accent-color);
        }

        .processing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-item.processing .processing-indicator {
            display: flex;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .remove-file {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .remove-file:hover {
            background: #dc2626;
        }

        /* Price Display */
        .price-display {
            background: linear-gradient(135deg, var(--accent-color), #059669);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            color: white;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .price-display.show {
            display: block;
            animation: slideInUp 0.3s ease-out;
        }

        .price-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .price-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .price-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .price-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .price-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .price-item-label {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .price-item-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .price-total {
            background: rgba(255, 255, 255, 0.15);
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .price-total-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .price-total-amount {
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Submit Section */
        .submit-section {
            border-top: 1px solid var(--border-color);
            padding-top: 2rem;
            margin-top: 2rem;
            text-align: center;
        }

        /* Cash Payment Modal */
        .cash-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cash-modal.show {
            display: flex;
            opacity: 1;
        }

        .cash-modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        .cash-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .cash-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .cash-subtitle {
            color: var(--text-secondary);
        }

        .arduino-code-section {
            background: var(--secondary-color);
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .arduino-code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            margin: 1rem 0;
            border: 3px solid var(--accent-color);
        }

        .arduino-instructions {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #059669;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .arduino-instructions h4 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .arduino-instructions ol {
            margin-left: 1.25rem;
        }

        .arduino-instructions li {
            margin-bottom: 0.25rem;
        }

        .order-summary {
            background: var(--secondary-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .order-summary-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .order-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .order-summary-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-color);
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .cash-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 2rem;
        }

        .btn-secondary:hover {
            background: var(--secondary-color);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--accent-color);
            color: white;
            padding: 0.75rem 2rem;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* E-Payment Modal */
        .e-payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .e-payment-modal.show {
            display: flex;
            opacity: 1;
        }

        .e-payment-modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        .e-payment-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .e-payment-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .e-payment-subtitle {
            color: var(--text-secondary);
        }

        .e-payment-summary {
            background: var(--secondary-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .e-payment-summary-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .e-payment-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .e-payment-summary-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary-color);
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .e-payment-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Toast Messages */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1500;
        }

        .toast {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--accent-color);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 300px;
        }

        .toast.error {
            border-left-color: var(--error-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-in;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* Logout Confirmation Modal */
        .logout-modal {
            text-align: center;
            max-width: 400px;
        }

        .logout-modal-icon {
            width: 80px;
            height: 80px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: var(--error-color);
        }

        .logout-modal h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .logout-modal p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .logout-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
            padding: 0.75rem 2rem;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* File Upload Progress */
        .upload-progress {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #059669;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
        }

        .upload-progress.show {
            display: block;
        }

        .upload-progress i {
            margin-right: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-section {
                padding: 3rem 1rem;
                margin: -2rem -1rem 2rem -1rem;
            }

            .hero-title {
                font-size: 2.25rem;
            }

            .hero-subtitle {
                font-size: 1.125rem;
            }

            .hero-features {
                gap: 1rem;
            }

            .feature-item {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: var(--sidebar-width);
                transform: translateX(-100%);
            }

            .sidebar.collapsed.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: 80px;
            }

            .sidebar.collapsed ~ .main-content {
                margin-left: 0;
            }

            .upload-container {
                padding: 2rem;
                margin: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .price-breakdown {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .logout-modal-actions {
                flex-direction: column;
            }

            .logout-modal-actions .btn {
                width: 100%;
            }

            .e-payment-actions {
                flex-direction: column;
            }

            .e-payment-actions .btn {
                width: 100%;
            }

            .cash-actions {
                flex-direction: column;
            }

            .cash-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .upload-area {
                padding: 2rem 1rem;
            }

            .upload-icon {
                font-size: 2rem;
            }

            .page-title {
                font-size: 1.75rem;
            }

            .price-total-amount {
                font-size: 2rem;
            }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="2) Dashboard.html" class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-print"></i>
                </div>
                <div class="sidebar-logo-text">Printerest</div>
            </a>
            <button class="sidebar-toggle" id="sidebarToggle" hidden>
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="2) Dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-link-text">Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="Upload.html" class="nav-link active">
                    <i class="fas fa-upload"></i>
                    <span class="nav-link-text">Upload</span>
                </a>
            </div>
             <li class="nav-item">
                <a href="4) Add Money.html" class="nav-link">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="nav-link-text">Add Money</span>
                </a>
            </li>
            <div class="nav-item">
                <a href="5) About Us.html" class="nav-link">
                    <i class="fas fa-info-circle"></i>
                    <span class="nav-link-text">About</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="6) Contact Us.html" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-link-text">Contact</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <!-- E-wallet Display -->
            <div class="wallet-display">
                <div class="wallet-title">
                    <i class="fas fa-wallet"></i>
                    E-Wallet
                </div>
                <div class="wallet-amount" id="walletAmount">₱0.00</div>
            </div>

            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">JD</div>
                <div class="user-info">
                    <div class="user-name" id="userName">John<br>Doe</div>
                    <div class="user-role">Student</div>
                </div>
            </div>

            <!-- Logout Button -->
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span class="logout-btn-text">Logout</span>
            </button>
        </div>
    </div>

    <!-- Sidebar Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal logout-modal">
            <div class="logout-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Confirm Logout</h2>
            <p>Are you sure you want to logout? You will need to sign in again to access your account.</p>
            <div class="logout-modal-actions">
                <button class="btn btn-secondary" id="cancelLogout">
                    <i class="fas fa-times"></i>
                    No, Cancel
                </button>
                <button class="btn btn-danger" id="confirmLogout">
                    <i class="fas fa-sign-out-alt"></i>
                    Yes, Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Cash Payment Modal -->
    <div class="cash-modal" id="cashModal">
        <div class="cash-modal-content">
            <div class="cash-header">
                <h2 class="cash-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Cash Payment - Arduino Code
                </h2>
                <p class="cash-subtitle">Your unique collection code for the Arduino printer</p>
            </div>

            <div class="arduino-code-section">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">
                    <i class="fas fa-microchip"></i>
                    Arduino Collection Code
                </h3>
                <div class="arduino-code-display" id="arduinoCodeDisplay">
                    XXXX
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    This code will be used to release your prints from the Arduino-controlled printer
                </p>
            </div>

            <div class="arduino-instructions">
                <h4><i class="fas fa-list-ol"></i> Instructions:</h4>
                <ol>
                    <li>Remember or write down your Arduino code: <strong id="codeReminder">XXXX</strong></li>
                    <li>Go to the printing station</li>
                    <li>Enter this code on the Arduino keypad</li>
                    <li>Pay the exact amount when collecting your prints</li>
                    <li>Your prints will be dispensed automatically</li>
                </ol>
            </div>

            <div class="order-summary">
                <div class="order-summary-title">Order Summary</div>
                <div class="order-summary-item">
                    <span>Total Pages:</span>
                    <span id="cashTotalPages">0</span>
                </div>
                <div class="order-summary-item">
                    <span>Copies:</span>
                    <span id="cashCopies">1</span>
                </div>
                <div class="order-summary-item">
                    <span>Color Mode:</span>
                    <span id="cashColorMode">-</span>
                </div>
                <div class="order-summary-item">
                    <span>Price per Page:</span>
                    <span id="cashPricePerPage">₱0.00</span>
                </div>
                <div class="order-summary-total">
                    <span>Total Amount:</span>
                    <span id="cashTotalAmount">₱0.00</span>
                </div>
            </div>

            <div class="cash-actions">
                <button class="btn btn-secondary" id="cancelCashPayment">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-success" id="confirmCashPayment">
                    <i class="fas fa-check"></i>
                    Confirm & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- E-Payment Modal (Simplified - No QR Code) -->
    <div class="e-payment-modal" id="ePaymentModal">
        <div class="e-payment-modal-content">
            <div class="e-payment-header">
                <h2 class="e-payment-title">
                    <i class="fas fa-wallet"></i>
                    E-Payment Confirmation
                </h2>
                <p class="e-payment-subtitle">Confirm your payment using E-Wallet balance</p>
            </div>

            <div class="e-payment-summary">
                <div class="e-payment-summary-title">Payment Summary</div>
                <div class="e-payment-summary-item">
                    <span>Total Pages:</span>
                    <span id="paymentTotalPages">0</span>
                </div>
                <div class="e-payment-summary-item">
                    <span>Copies:</span>
                    <span id="paymentCopies">1</span>
                </div>
                <div class="e-payment-summary-item">
                    <span>Color Mode:</span>
                    <span id="paymentColorMode">-</span>
                </div>
                <div class="e-payment-summary-item">
                    <span>Price per Page:</span>
                    <span id="paymentPricePerPage">₱0.00</span>
                </div>
                <div class="e-payment-summary-item">
                    <span>Current E-Wallet Balance:</span>
                    <span id="modalCurrentBalance">₱0.00</span>
                </div>
                <div class="e-payment-summary-total">
                    <span>Amount to Pay:</span>
                    <span id="paymentTotalAmount">₱0.00</span>
                </div>
                <div class="e-payment-summary-item" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; font-weight: 600; color: var(--accent-color);">
                    <span>Remaining Balance:</span>
                    <span id="remainingBalance">₱0.00</span>
                </div>
            </div>

            <div class="e-payment-actions">
                <button class="btn btn-secondary" id="cancelEPayment">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="btn btn-success" id="confirmEPayment">
                    <i class="fas fa-credit-card"></i>
                    Pay with E-Wallet
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Section with Gradient Background -->
        <div class="hero-section">
            <div class="hero-content">
                <div class="hero-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h1 class="hero-title">Upload Documents</h1>
                <p class="hero-subtitle">Upload your documents for printing with automatic page counting, file size tracking, and real-time pricing</p>
                <div class="hero-features">
                    <div class="feature-item">
                        <i class="fas fa-file-alt"></i>
                        <span>Auto Page Count</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-hdd"></i>
                        <span>File Size Display</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-calculator"></i>
                        <span>Real-time Pricing</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="upload-container">
            <form id="uploadForm">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-subtext">Supported formats: PDF, DOC, DOCX, PPT, PPTX (Max 10MB each)</div>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx">
                    <button type="button" class="btn btn-primary" id="browseBtn">
                        <i class="fas fa-upload"></i>
                        Choose Files
                    </button>
                </div>

                <div id="fileList"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="subject">Subject/Course *</label>
                        <input type="text" id="subject" name="subject" required placeholder="e.g. Mathematics, Computer Science">
                    </div>

                    <div class="form-group">
                        <label for="copies">Number of Copies *</label>
                        <input type="number" id="copies" name="copies" min="1" max="100" value="1" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="paperSize">Paper Size *</label>
                        <select id="paperSize" name="paperSize" required>
                            <option value="">Select paper size</option>
                            <option value="A4">A4 (8.3 × 11.7 in)</option>
                            <option value="Letter">Letter (8.5 × 11 in)</option>
                            <option value="Legal">Legal (8.5 × 14 in)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="colorMode">Color Mode *</label>
                        <select id="colorMode" name="colorMode" required>
                            <option value="">Select color mode</option>
                            <option value="BW">Black & White - ₱2.00/page</option>
                            <option value="Color">Color - ₱5.00/page</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Any special instructions for printing">
                </div>

                <!-- Payment Method Selection -->
                <div class="payment-method-section">
                    <h3 class="payment-method-title">
                        <i class="fas fa-credit-card"></i>
                        Payment Method
                    </h3>
                    <div class="payment-methods">
                        <div class="payment-method cash" onclick="selectPaymentMethod('cash')">
                            <input type="radio" name="paymentMethod" value="cash" class="payment-method-radio" id="cashPayment">
                            <i class="fas fa-money-bill-wave payment-method-icon"></i>
                            <div class="payment-method-name">Cash Payment</div>
                            <div class="payment-method-desc">Pay when you collect your prints</div>
                        </div>
                        <div class="payment-method g-cash" onclick="selectPaymentMethod('g-cash')">
                            <input type="radio" name="paymentMethod" value="g-cash" class="payment-method-radio" id="gCashPayment">
                            <i class="fas fa-mobile-alt payment-method-icon"></i>
                            <div class="payment-method-name">E-Payment</div>
                            <div class="payment-method-desc">Pay now using your E-Wallet account</div>
                        </div>
                    </div>
                    
                    <div class="cash-notice" id="cashNotice">
                        <i class="fas fa-info-circle"></i>
                        <strong>Cash Payment:</strong> Your order will be submitted immediately. Please bring the exact amount (₱<span id="cashAmount">0.00</span>) when collecting your prints.
                    </div>

                    <div class="cash-notice" id="g-cash-notice" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #1d4ed8;">
                        <i class="fas fa-wallet"></i>
                        <strong>Current E-Wallet Balance:</strong> ₱<span id="currentWalletBalance">0.00</span>
                    </div>
                </div>

                <!-- Price Display -->
                <div class="price-display" id="priceDisplay">
                    <div class="price-header">
                        <div class="price-title">
                            <i class="fas fa-calculator"></i>
                            Total Cost Calculation
                        </div>
                        <div class="price-subtitle">Based on actual page count and selected options</div>
                    </div>
                    
                    <div class="price-breakdown">
                        <div class="price-item">
                            <div class="price-item-label">Total Pages</div>
                            <div class="price-item-value" id="totalPagesDisplay">0</div>
                        </div>
                        <div class="price-item">
                            <div class="price-item-label">Copies</div>
                            <div class="price-item-value" id="copiesDisplay">1</div>
                        </div>
                        <div class="price-item">
                            <div class="price-item-label">Price per Page</div>
                            <div class="price-item-value" id="pricePerPageDisplay">₱0.00</div>
                        </div>
                        <div class="price-item">
                            <div class="price-item-label">Files</div>
                            <div class="price-item-value" id="filesCountDisplay">0</div>
                        </div>
                        <div class="price-item">
                            <div class="price-item-label">Total File Size</div>
                            <div class="price-item-value" id="totalFileSizeDisplay">0 KB</div>
                        </div>
                    </div>

                    <div class="price-total">
                        <div class="price-total-label">Total Amount</div>
                        <div class="price-total-amount" id="totalAmountDisplay">₱0.00</div>
                    </div>
                </div>

                <!-- Upload Progress Display -->
                <div class="upload-progress" id="uploadProgress">
                    <div class="upload-progress-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="uploadProgressText">Preparing upload...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        Submit Print Job
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const FIREBASE_URL = 'https://printerest2025-83043-default-rtdb.firebaseio.com';
        const firebaseConfig = {
            databaseURL: FIREBASE_URL
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Google Drive Configuration
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyD1co_l1HHDUJTHJn9A52OO0N4DP0WO19U',
            clientId: '466463419529-lng82ouj8p5vm05n3e8675asil3pu1qa.apps.googleusercontent.com',
            uploadFolderId: '1JZBpsJPRSmbm-Bxz3flIi8RQW3fTTjxr' // FILES UPLOADED FOLDER
        };

        // Global variables for Google Drive
        let googleAccessToken = null;
        let isGoogleAPIReady = false;

        // Global Variables
        let userProfile = {
            firstName: 'John',
            lastName: 'Doe',
            email: '',
            studentId: '',
            course: '',
            userId: ''
        };

        // File upload variables
        let selectedFiles = [];
        let currentUser = null;
        let totalPages = 0;
        let totalCost = 0;
        let selectedPaymentMethod = null;
        let currentPaymentIntentId = null;
        let paymentCheckInterval = null;
        let currentArduinoCode = null;
        let currentEWalletBalance = 0; // Store current e-wallet balance

        // File processing queue
        let processingQueue = [];
        let isProcessing = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            setupSidebar();
            setupLogoutModal();
            setupFileUpload();
            setupPriceCalculation();
            setupEPaymentModal();
            setupCashModal();
            setupFormSubmission();
            initializeGoogleDrive();
        });

        function loadUserData() {
            // Load user data from localStorage (same key as login/dashboard)
            const storedUser = localStorage.getItem('printerest_user');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    userProfile = {
                        userId: userData.userId || 'userinfo0001',
                        firstName: userData.firstName || 'John',
                        lastName: userData.lastName || 'Doe',
                        email: userData.email || '',
                        studentId: userData.studentId || '',
                        course: userData.course || ''
                    };
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    setDefaultUserProfile();
                }
            } else {
                setDefaultUserProfile();
            }

            updateUserDisplay();
            loadEWalletData(); // Load e-wallet data after user data is loaded
        }

        function setDefaultUserProfile() {
            userProfile = {
                userId: 'userinfo0001',
                firstName: 'John',
                lastName: 'Doe',
                email: '',
                studentId: '',
                course: ''
            };
            localStorage.setItem('printerest_user', JSON.stringify(userProfile));
        }

        async function loadEWalletData() {
            try {
                if (!userProfile.userId) {
                    console.log('No user ID found for e-wallet lookup');
                    return;
                }

                console.log('Loading e-wallet data for user:', userProfile.userId);

                // Fetch user data from Firebase to get e_wallet_stats
                const response = await fetch(`${FIREBASE_URL}/users/${userProfile.userId}.json`);

                if (!response.ok) {
                    if (response.status === 404) {
                        // User record doesn't exist, display zero
                        currentEWalletBalance = 0;
                        document.getElementById('walletAmount').textContent = '₱0.00';
                        document.getElementById('currentWalletBalance').textContent = '0.00';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const userData = await response.json();
                console.log('User data for e-wallet:', userData);

                if (userData && typeof userData.e_wallet_stats !== 'undefined') {
                    const amount = parseFloat(userData.e_wallet_stats || 0);
                    currentEWalletBalance = amount;
                    document.getElementById('walletAmount').textContent = `₱${amount.toFixed(2)}`;
                    
                    // Update GCash notice balance display
                    const currentWalletBalance = document.getElementById('currentWalletBalance');
                    if (currentWalletBalance) {
                        currentWalletBalance.textContent = amount.toFixed(2);
                    }
                } else {
                    // No e_wallet_stats found, display zero
                    currentEWalletBalance = 0;
                    document.getElementById('walletAmount').textContent = '₱0.00';
                    document.getElementById('currentWalletBalance').textContent = '0.00';
                }

            } catch (error) {
                console.error('Error loading e-wallet data:', error);
                // On error, keep the default value
                currentEWalletBalance = 0;
                document.getElementById('walletAmount').textContent = '₱0.00';
                document.getElementById('currentWalletBalance').textContent = '0.00';
            }
        }

        function updateUserDisplay() {
            // Load user data from localStorage (same as dashboard)
            const storedUser = localStorage.getItem('printerest_user');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    userProfile = {
                        userId: userData.userId || 'userinfo0001',
                        firstName: userData.firstName || 'John',
                        lastName: userData.lastName || 'Doe',
                        email: userData.email || '',
                        studentId: userData.studentId || '',
                        course: userData.course || ''
                    };
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }
            }

            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');

            if (userProfile && userProfile.firstName && userProfile.lastName) {
                const fullName = `${userProfile.firstName} ${userProfile.lastName}`;
                const initials = `${userProfile.firstName.charAt(0)}${userProfile.lastName.charAt(0)}`.toUpperCase();

                if (userAvatar) {
                    userAvatar.textContent = initials;
                }

                if (userName) {
                    // Split the full name into two lines for better display
                    const names = fullName.split(' ');
                    if (names.length >= 2) {
                        const firstName = names[0];
                        const lastName = names.slice(1).join(' ');
                        userName.innerHTML = `${firstName}<br>${lastName}`;
                    } else {
                        userName.textContent = fullName;
                    }
                }
            } else {
                // Use default values if no profile data
                if (userAvatar) {
                    userAvatar.textContent = 'JD';
                }

                if (userName) {
                    userName.innerHTML = 'John<br>Doe';
                }
            }
        }

        function setupSidebar() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // Mobile menu button
            if (mobileMenuBtn && sidebar && sidebarOverlay) {
                mobileMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.toggle('show');
                    sidebarOverlay.classList.toggle('show');
                });
            }

            // Desktop sidebar toggle
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.innerWidth > 768) {
                        sidebar.classList.toggle('collapsed');
                    } else {
                        sidebar.classList.remove('show');
                        sidebarOverlay.classList.remove('show');
                    }
                });
            }

            // Overlay click to close
            if (sidebarOverlay && sidebar) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                });
            }

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }
            });

            // Prevent body scroll when sidebar is open on mobile
            const body = document.body;
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'class') {
                        if (sidebar.classList.contains('show') && window.innerWidth <= 768) {
                            body.style.overflow = 'hidden';
                        } else {
                            body.style.overflow = '';
                        }
                    }
                });
            });
            observer.observe(sidebar, { attributes: true });
        }

        function setupLogoutModal() {
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutModal = document.getElementById('logoutModal');
            const cancelLogout = document.getElementById('cancelLogout');
            const confirmLogout = document.getElementById('confirmLogout');

            // Show logout modal when logout button is clicked
            if (logoutBtn && logoutModal) {
                logoutBtn.addEventListener('click', function() {
                    logoutModal.classList.add('show');
                });
            }

            // Cancel logout - close modal
            if (cancelLogout && logoutModal) {
                cancelLogout.addEventListener('click', function() {
                    logoutModal.classList.remove('show');
                });
            }

            // Confirm logout - redirect to login page
            if (confirmLogout) {
                confirmLogout.addEventListener('click', function() {
                    // Show loading state
                    confirmLogout.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
                    confirmLogout.disabled = true;
                    
                    // Clear local storage and redirect
                    localStorage.removeItem('printerest_user');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                });
            }

            // Close modal when clicking outside
            if (logoutModal) {
                logoutModal.addEventListener('click', function(e) {
                    if (e.target === logoutModal) {
                        logoutModal.classList.remove('show');
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && logoutModal.classList.contains('show')) {
                    logoutModal.classList.remove('show');
                }
            });
        }

        function setupCashModal() {
            const cashModal = document.getElementById('cashModal');
            const cancelCashPayment = document.getElementById('cancelCashPayment');
            const confirmCashPayment = document.getElementById('confirmCashPayment');

            // Cancel cash payment
            cancelCashPayment.addEventListener('click', function() {
                closeCashModal();
            });

            // Confirm cash payment - submit to Firebase and copy files
            confirmCashPayment.addEventListener('click', async function() {
                try {
                    confirmCashPayment.disabled = true;
                    confirmCashPayment.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                    
                    await submitPrintJobToFirebase('CASH PAYMENT', currentArduinoCode);
                    closeCashModal();
                } catch (error) {
                    console.error('Cash payment error:', error);
                    showToast('Submission failed: ' + error.message, 'error');
                } finally {
                    confirmCashPayment.disabled = false;
                    confirmCashPayment.innerHTML = '<i class="fas fa-check"></i> Confirm & Submit';
                }
            });

            // Close modal when clicking outside
            cashModal.addEventListener('click', function(e) {
                if (e.target === cashModal) {
                    closeCashModal();
                }
            });
        }

        function setupEPaymentModal() {
            const ePaymentModal = document.getElementById('ePaymentModal');
            const cancelEPayment = document.getElementById('cancelEPayment');
            const confirmEPayment = document.getElementById('confirmEPayment');

            // Cancel E-Payment
            cancelEPayment.addEventListener('click', function() {
                closeEPaymentModal();
            });

            // Confirm E-Payment - process immediately without QR code
            confirmEPayment.addEventListener('click', async function() {
                try {
                    confirmEPayment.disabled = true;
                    confirmEPayment.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Payment...';
                    
                    // Process E-Payment immediately
                    await submitPrintJobToFirebase('E-PAYMENT', null);
                    closeEPaymentModal();
                    
                } catch (error) {
                    console.error('E-Payment error:', error);
                    showToast('Payment failed: ' + error.message, 'error');
                } finally {
                    confirmEPayment.disabled = false;
                    confirmEPayment.innerHTML = '<i class="fas fa-credit-card"></i> Pay with E-Wallet';
                }
            });

            // Close modal when clicking outside
            ePaymentModal.addEventListener('click', function(e) {
                if (e.target === ePaymentModal) {
                    closeEPaymentModal();
                }
            });
        }

        function generateArduinoCode() {
            // Generate a unique 4-digit code
            const digits = '0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += digits.charAt(Math.floor(Math.random() * digits.length));
            }
            return code;
        }

        async function generatePrintJobId() {
            try {
                // Get the current count of print jobs to determine the next sequential number
                const printJobsRef = database.ref('print_jobs');
                const snapshot = await printJobsRef.once('value');
                const printJobs = snapshot.val() || {};

                // Count existing print jobs and add 1 for the next ID
                const count = Object.keys(printJobs).length + 1;

                // Format as printjob#### (4 digits with leading zeros)
                return `printjob${count.toString().padStart(4, '0')}`;
            } catch (error) {
                console.error('Error generating print job ID:', error);
                // Fallback to timestamp-based ID if there's an error
                const timestamp = Date.now();
                return `printjob${timestamp}`;
            }
        }

        function getUserInfoId() {
            // Get user info ID from localStorage or generate one
            const storedUser = localStorage.getItem('printerest_user');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    return userData.userId || `USER_${Date.now()}`;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }
            }
            return `USER_${Date.now()}`;
        }

        function showCashModal() {
            const cashModal = document.getElementById('cashModal');
            const colorMode = document.getElementById('colorMode').value;
            const copies = parseInt(document.getElementById('copies').value) || 1;
            const pricePerPage = colorMode === 'Color' ? 5.00 : 2.00;

            // Generate unique Arduino code
            currentArduinoCode = generateArduinoCode();

            // Update Arduino code display
            document.getElementById('arduinoCodeDisplay').textContent = currentArduinoCode;
            document.getElementById('codeReminder').textContent = currentArduinoCode;

            // Update payment summary
            document.getElementById('cashTotalPages').textContent = totalPages;
            document.getElementById('cashCopies').textContent = copies;
            document.getElementById('cashColorMode').textContent = colorMode === 'Color' ? 'Color' : 'Black & White';
            document.getElementById('cashPricePerPage').textContent = `₱${pricePerPage.toFixed(2)}`;
            document.getElementById('cashTotalAmount').textContent = `₱${totalCost.toFixed(2)}`;

            cashModal.classList.add('show');
        }

        function closeCashModal() {
            const cashModal = document.getElementById('cashModal');
            cashModal.classList.remove('show');
            currentArduinoCode = null;
        }

        function showEPaymentModal() {
            const ePaymentModal = document.getElementById('ePaymentModal');
            const colorMode = document.getElementById('colorMode').value;
            const copies = parseInt(document.getElementById('copies').value) || 1;
            const pricePerPage = colorMode === 'Color' ? 5.00 : 2.00;

            // Update payment summary
            document.getElementById('paymentTotalPages').textContent = totalPages;
            document.getElementById('paymentCopies').textContent = copies;
            document.getElementById('paymentColorMode').textContent = colorMode === 'Color' ? 'Color' : 'Black & White';
            document.getElementById('paymentPricePerPage').textContent = `₱${pricePerPage.toFixed(2)}`;
            document.getElementById('paymentTotalAmount').textContent = `₱${totalCost.toFixed(2)}`;
            document.getElementById('modalCurrentBalance').textContent = `₱${currentEWalletBalance.toFixed(2)}`;
            
            // Calculate remaining balance
            const remainingBalance = currentEWalletBalance - totalCost;
            document.getElementById('remainingBalance').textContent = `₱${remainingBalance.toFixed(2)}`;

            ePaymentModal.classList.add('show');
        }

        function closeEPaymentModal() {
            const ePaymentModal = document.getElementById('ePaymentModal');
            ePaymentModal.classList.remove('show');
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selectedElement = document.querySelector(`.payment-method.${method}`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            // Update radio button
            const radioButton = document.getElementById(method + 'Payment');
            if (radioButton) {
                radioButton.checked = true;
            }
            
            // Show/hide notices
            const cashNotice = document.getElementById('cashNotice');
            const gcashNotice = document.getElementById('g-cash-notice');
            
            if (method === 'cash') {
                cashNotice.classList.add('show');
                gcashNotice.classList.remove('show');
                document.getElementById('cashAmount').textContent = totalCost.toFixed(2);
            } else if (method === 'g-cash') {
                cashNotice.classList.remove('show');
                gcashNotice.classList.add('show');
            } else {
                cashNotice.classList.remove('show');
                gcashNotice.classList.remove('show');
            }
            
            // Update submit button text
            updateSubmitButtonText();
        }

        function updateSubmitButtonText() {
            const submitBtn = document.getElementById('submitBtn');
            if (selectedPaymentMethod === 'cash') {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Print Job (Cash on Collection)';
            } else if (selectedPaymentMethod === 'g-cash') {
                submitBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> Submit Online Payment';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Print Job';
            }
        }

        // Google Drive API initialization
        function initializeGoogleDrive() {
            console.log('Initializing Google Drive API...');

            try {
                if (window.google && window.google.accounts) {
                    isGoogleAPIReady = true;
                    console.log('Google Identity Services loaded successfully');
                } else {
                    console.log('Google Identity Services not yet loaded, retrying...');
                    setTimeout(initializeGoogleDrive, 1000);
                }
            } catch (error) {
                console.error('Error initializing Google Drive API:', error);
                setTimeout(initializeGoogleDrive, 2000);
            }
        }

        // Get Google access token using Identity Services
        async function getGoogleAccessToken() {
            return new Promise((resolve, reject) => {
                if (!window.google) {
                    reject(new Error('Google Identity Services not loaded'));
                    return;
                }

                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CONFIG.clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.error) {
                            reject(new Error(response.error));
                        } else {
                            googleAccessToken = response.access_token;
                            resolve(response.access_token);
                        }
                    }
                });

                tokenClient.requestAccessToken();
            });
        }

        // Upload file to Google Drive
        async function uploadToGoogleDrive(file) {
            console.log('Starting Google Drive upload for:', file.name);

            if (!isGoogleAPIReady) {
                throw new Error('Google API not initialized');
            }

            try {
                // Get access token if we don't have one
                if (!googleAccessToken) {
                    console.log('Getting Google access token...');
                    showToast('Please authorize access to Google Drive...', 'info');
                    await getGoogleAccessToken();
                }

                // Get subject for filename
                const subject = document.getElementById('subject').value.trim() || 'Unknown';
                const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                // Create filename: (fullname)_Subject/Course_date
                const userFullName = `${userProfile.firstName}${userProfile.lastName}`.replace(/\s+/g, '');
                const fileExtension = file.name.split('.').pop();
                const sanitizedSubject = subject.replace(/[\/\\:*?"<>|]/g, '_'); // Replace invalid characters
                const fileName = `${userFullName}_${sanitizedSubject}_${currentDate}.${fileExtension}`;

                // Create file metadata
                const metadata = {
                    name: fileName,
                    parents: [GOOGLE_CONFIG.uploadFolderId],
                    description: `Document uploaded by ${userProfile.firstName} ${userProfile.lastName} for ${subject} on ${currentDate}`
                };

                // Create form data for multipart upload
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', file);

                // Upload file
                console.log('Uploading file to Google Drive...');
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    },
                    body: form
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired, get a new one
                        googleAccessToken = null;
                        await getGoogleAccessToken();
                        return uploadToGoogleDrive(file); // Retry upload
                    }
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const fileData = await response.json();
                console.log('File uploaded successfully:', fileData);

                // Make file publicly viewable
                await fetch(`https://www.googleapis.com/drive/v3/files/${fileData.id}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: 'reader',
                        type: 'anyone'
                    })
                });

                // Return the public URL
                const publicUrl = `https://drive.google.com/file/d/${fileData.id}/view`;
                console.log('File is now publicly accessible:', publicUrl);

                return {
                    fileId: fileData.id,
                    fileName: fileName,
                    originalName: file.name,
                    publicUrl: publicUrl,
                    size: file.size,
                    uploadDate: currentDate
                };

            } catch (error) {
                console.error('Error uploading to Google Drive:', error);
                throw new Error(`Failed to upload file to Google Drive: ${error.message}`);
            }
        }

        // Upload files to Google Drive
        async function uploadFilesToGoogleDrive() {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadProgressText = document.getElementById('uploadProgressText');

            try {
                // Show upload progress
                uploadProgress.classList.add('show');
                uploadProgressText.textContent = 'Uploading files to Google Drive...';
                progressFill.style.width = '0%';

                const uploadedFiles = [];

                // Upload each file individually to Google Drive
                for (let i = 0; i < selectedFiles.length; i++) {
                    const fileData = selectedFiles[i];
                    const file = fileData.file;

                    // Update progress text
                    uploadProgressText.textContent = `Uploading file ${i + 1} of ${selectedFiles.length}: ${file.name}`;
                    
                    // Update progress bar
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    progressFill.style.width = `${progress}%`;

                    try {
                        const result = await uploadToGoogleDrive(file);
                        uploadedFiles.push({
                            ...result,
                            pages: fileData.pages || 1
                        });
                        console.log(`Successfully uploaded: ${file.name}`);
                    } catch (error) {
                        console.error(`Failed to upload ${file.name}:`, error);
                        throw error;
                    }
                }

                uploadProgressText.textContent = 'Upload completed successfully!';
                progressFill.style.width = '100%';

                return uploadedFiles;

            } catch (error) {
                console.error('Error uploading files:', error);
                uploadProgressText.textContent = 'Upload failed!';
                throw error;
            }
        }

        // Calculate total cost - FIXED: Only multiply price per page by copies, not total pages
        function calculateTotalCost() {
            const copies = parseInt(document.getElementById('copies').value) || 1;
            const colorMode = document.getElementById('colorMode').value;
            
            if (!colorMode || totalPages === 0) {
                return 0;
            }

            const pricePerPage = colorMode === 'Color' ? 5.00 : 2.00;
            // FIXED: Total cost = total pages × price per page × copies
            // But total pages should remain the actual page count, not multiplied by copies
            return totalPages * pricePerPage * copies;
        }

        // Setup price calculation
        function setupPriceCalculation() {
            const colorModeSelect = document.getElementById('colorMode');
            const copiesInput = document.getElementById('copies');

            function updatePricing() {
                const copies = parseInt(copiesInput.value) || 1;
                const colorMode = colorModeSelect.value;
                
                if (selectedFiles.length > 0 && colorMode) {
                    const pricePerPage = colorMode === 'Color' ? 5.00 : 2.00;
                    totalCost = calculateTotalCost();
                    
                    // Update display elements - totalPages remains the actual page count
                    document.getElementById('totalPagesDisplay').textContent = totalPages;
                    document.getElementById('copiesDisplay').textContent = copies;
                    document.getElementById('pricePerPageDisplay').textContent = `₱${pricePerPage.toFixed(2)}`;
                    document.getElementById('filesCountDisplay').textContent = selectedFiles.length;
                    
                    // Calculate total file size
                    const totalSize = selectedFiles.reduce((sum, file) => sum + file.file.size, 0);
                    document.getElementById('totalFileSizeDisplay').textContent = formatFileSize(totalSize);
                    
                    // Update total amount
                    document.getElementById('totalAmountDisplay').textContent = `₱${totalCost.toFixed(2)}`;
                    
                    // Show price display
                    document.getElementById('priceDisplay').classList.add('show');
                    
                    // Update payment method notices
                    if (selectedPaymentMethod === 'cash') {
                        document.getElementById('cashAmount').textContent = totalCost.toFixed(2);
                    }
                } else {
                    document.getElementById('priceDisplay').classList.remove('show');
                    totalCost = 0;
                }
            }

            // Add event listeners
            colorModeSelect.addEventListener('change', updatePricing);
            copiesInput.addEventListener('input', updatePricing);
        }

        // Setup form submission
        function setupFormSubmission() {
            const uploadForm = document.getElementById('uploadForm');
            
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm()) {
                    return;
                }

                // Check payment method
                if (selectedPaymentMethod === 'cash') {
                    // For cash payment, show modal
                    showCashModal();
                } else if (selectedPaymentMethod === 'g-cash') {
                    // For E-Payment, check e-wallet balance first
                    if (totalCost > currentEWalletBalance) {
                        showToast('Please add funds to your e-wallet to complete the transaction.', 'error');
                        return;
                    }
                    
                    // If sufficient balance, show E-Payment modal
                    showEPaymentModal();
                } else {
                    showToast('Please select a payment method', 'error');
                }
            });
        }

        function validateForm() {
            // Check if files are selected
            if (selectedFiles.length === 0) {
                showToast('Please select at least one file to upload', 'error');
                return false;
            }

            // Check required fields
            const subject = document.getElementById('subject').value.trim();
            if (!subject) {
                showToast('Please enter a subject/course', 'error');
                return false;
            }

            const paperSize = document.getElementById('paperSize').value;
            if (!paperSize) {
                showToast('Please select a paper size', 'error');
                return false;
            }

            const colorMode = document.getElementById('colorMode').value;
            if (!colorMode) {
                showToast('Please select a color mode', 'error');
                return false;
            }

            const copies = parseInt(document.getElementById('copies').value);
            if (!copies || copies < 1 || copies > 100) {
                showToast('Please enter a valid number of copies (1-100)', 'error');
                return false;
            }

            return true;
        }

        // Submit print job to Firebase with e-wallet deduction for E-Payment
        async function submitPrintJobToFirebase(paymentMethod, arduinoCode) {
            try {
                // First upload files to Google Drive
                const uploadedFiles = await uploadFilesToGoogleDrive();
                
                // Generate print job ID
                const printJobId = await generatePrintJobId();
                const currentDate = new Date().toISOString();
                
                // Get form data
                const subject = document.getElementById('subject').value.trim();
                const paperSize = document.getElementById('paperSize').value;
                const colorMode = document.getElementById('colorMode').value;
                const copies = parseInt(document.getElementById('copies').value) || 1;
                const notes = document.getElementById('notes').value.trim();
                const pricePerPage = colorMode === 'Color' ? 5.00 : 2.00;

                // Calculate total pages including copies (original_page_count * number_of_copies)
                const totalPagesWithCopies = totalPages * copies;

                // Determine payment method value for Firebase based on the requirements
                let firebasePaymentMethod;
                if (paymentMethod === 'CASH PAYMENT') {
                    firebasePaymentMethod = 'CASH PAYMENT: PENDING';
                } else if (paymentMethod === 'E-PAYMENT') {
                    firebasePaymentMethod = 'E-WALLET PAYMENT';
                } else {
                    firebasePaymentMethod = paymentMethod; // fallback
                }

                // Prepare print job data
                const printJobData = {
                    print_job_id: printJobId,
                    user_info_id: userProfile.userId,
                    created_date: currentDate,
                    subject_course: subject,
                    paper_size: paperSize,
                    color_mode: colorMode,
                    number_of_copies: copies,
                    total_pages: totalPagesWithCopies,
                    price_per_page: pricePerPage,
                    total_amount: totalCost,
                    payment_method: firebasePaymentMethod, // Updated payment method value
                    payment_status: paymentMethod === 'E-PAYMENT' ? 'PAID' : 'PENDING',
                    print_status: 'PENDING',
                    additional_notes: notes || '',
                    arduino_code: arduinoCode || '',
                    uploaded_files: uploadedFiles.map(file => ({
                        file_name: file.fileName,
                        original_name: file.originalName,
                        google_drive_url: file.publicUrl,
                        file_id: file.fileId,
                        file_size: file.size,
                        pages: file.pages
                    }))
                };

                // Submit to Firebase
                console.log('Submitting print job to Firebase:', printJobData);
                await database.ref(`print_jobs/${printJobId}`).set(printJobData);
                
                // If E-Payment, deduct from e-wallet
                if (paymentMethod === 'E-PAYMENT') {
                    await deductFromEWallet(totalCost);
                }

                // Show success message
                showToast(`Print job submitted successfully! Job ID: ${printJobId}`, 'success');
                
                // Reset form
                resetForm();
                
                // Hide upload progress
                document.getElementById('uploadProgress').classList.remove('show');

            } catch (error) {
                console.error('Error submitting print job:', error);
                showToast('Failed to submit print job: ' + error.message, 'error');
                throw error;
            }
        }

        // Deduct amount from e-wallet
        async function deductFromEWallet(amount) {
            try {
                console.log(`Deducting ₱${amount.toFixed(2)} from e-wallet`);
                
                const newBalance = currentEWalletBalance - amount;
                
                // Update e-wallet in Firebase
                await database.ref(`users/${userProfile.userId}/e_wallet_stats`).set(newBalance);
                
                // Update local balance
                currentEWalletBalance = newBalance;
                
                // Update UI
                document.getElementById('walletAmount').textContent = `₱${newBalance.toFixed(2)}`;
                document.getElementById('currentWalletBalance').textContent = newBalance.toFixed(2);
                
                console.log(`E-wallet updated. New balance: ₱${newBalance.toFixed(2)}`);
                showToast(`₱${amount.toFixed(2)} deducted from e-wallet. New balance: ₱${newBalance.toFixed(2)}`, 'success');
                
            } catch (error) {
                console.error('Error updating e-wallet:', error);
                throw new Error('Failed to update e-wallet balance');
            }
        }

        function resetForm() {
            // Clear file selection
            selectedFiles = [];
            totalPages = 0;
            totalCost = 0;
            selectedPaymentMethod = null;
            
            // Reset form fields
            document.getElementById('uploadForm').reset();
            
            // Clear file list
            document.getElementById('fileList').innerHTML = '';
            
            // Hide price display
            document.getElementById('priceDisplay').classList.remove('show');
            
            // Reset payment method selection
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Hide notices
            document.getElementById('cashNotice').classList.remove('show');
            document.getElementById('g-cash-notice').classList.remove('show');
            
            // Reset submit button
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane"></i> Submit Print Job';
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');

            // Browse button click - prevent double triggering
            browseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });

            // Upload area click - prevent double triggering
            uploadArea.addEventListener('click', (e) => {
                // Only trigger if clicking the upload area itself, not the browse button
                if (e.target === uploadArea || e.target.classList.contains('upload-icon') || 
                    e.target.classList.contains('upload-text') || e.target.classList.contains('upload-subtext')) {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFileSelection(e.target.files);
                // Reset the input value to allow selecting the same file again
                e.target.value = '';
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelection(e.dataTransfer.files);
            });
        }

        function handleFileSelection(files) {
            const fileArray = Array.from(files);
            const validFiles = fileArray.filter(file => {
                const validTypes = ['.pdf', '.doc', '.docx', '.ppt', '.pptx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                const isValidType = validTypes.includes(fileExtension);
                const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
                
                if (!isValidType) {
                    showToast(`${file.name}: Unsupported file type`, 'error');
                    return false;
                }
                
                if (!isValidSize) {
                    showToast(`${file.name}: File too large (max 10MB)`, 'error');
                    return false;
                }
                
                return true;
            });

            if (validFiles.length > 0) {
                validFiles.forEach(file => {
                    if (!selectedFiles.find(f => f.file.name === file.name && f.file.size === file.size)) {
                        selectedFiles.push({
                            file: file,
                            pages: 0
                        });
                    }
                });
                
                updateFileList();
                processFilePages();
            }
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            fileList.innerHTML = selectedFiles.map((fileData, index) => {
                const file = fileData.file;
                const fileSize = formatFileSize(file.size);
                const fileIcon = getFileIcon(file.name);
                
                return `
                    <div class="file-item" id="file-${index}">
                        <div class="file-info">
                            <i class="fas ${fileIcon} file-icon"></i>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-meta">
                                    <span>Size: ${fileSize}</span>
                                    <span class="file-pages">Pages: ${fileData.pages || 'Processing...'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="processing-indicator">
                            <div class="spinner"></div>
                            <span>Processing...</span>
                        </div>
                        <button class="remove-file" onclick="removeFile(${index})" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateTotalPages();
            
            // Update pricing if color mode is selected
            const colorMode = document.getElementById('colorMode').value;
            if (colorMode && selectedFiles.length > 0) {
                setupPriceCalculation();
            } else {
                document.getElementById('priceDisplay').classList.remove('show');
                totalCost = 0;
            }
        }

        async function processFilePages() {
            for (let i = 0; i < selectedFiles.length; i++) {
                const fileData = selectedFiles[i];
                
                if (fileData.pages === 0) {
                    const fileItem = document.getElementById(`file-${i}`);
                    if (fileItem) {
                        fileItem.classList.add('processing');
                    }
                    
                    try {
                        const pages = await getFilePageCount(fileData.file);
                        fileData.pages = pages;
                        
                        if (fileItem) {
                            fileItem.classList.remove('processing');
                            const pagesSpan = fileItem.querySelector('.file-pages');
                            if (pagesSpan) {
                                pagesSpan.textContent = `Pages: ${pages}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        fileData.pages = 1; // Default to 1 page
                        
                        if (fileItem) {
                            fileItem.classList.remove('processing');
                            const pagesSpan = fileItem.querySelector('.file-pages');
                            if (pagesSpan) {
                                pagesSpan.textContent = 'Pages: 1 (estimated)';
                            }
                        }
                    }
                }
            }
            
            updateTotalPages();
        }

        function updateTotalPages() {
            totalPages = selectedFiles.reduce((sum, fileData) => sum + (fileData.pages || 0), 0);
            
            // Update pricing if needed
            const colorMode = document.getElementById('colorMode').value;
            if (colorMode && totalPages > 0) {
                const priceCalculation = setupPriceCalculation();
            }
        }

        async function getFilePageCount(file) {
            return new Promise((resolve, reject) => {
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                try {
                    if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
                        // Handle PDF files
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const typedArray = new Uint8Array(e.target.result);
                                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                                resolve(pdf.numPages);
                            } catch (error) {
                                console.error('Error reading PDF:', error);
                                resolve(1); // Default to 1 page
                            }
                        };
                        reader.onerror = () => resolve(1);
                        reader.readAsArrayBuffer(file);
                    } else if (fileName.endsWith('.docx')) {
                        // Handle DOCX files
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const arrayBuffer = e.target.result;
                                const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                                const text = result.value;
                                
                                // Estimate pages based on character count (rough estimation)
                                const estimatedPages = Math.max(1, Math.ceil(text.length / 2000));
                                resolve(estimatedPages);
                            } catch (error) {
                                console.error('Error reading DOCX:', error);
                                resolve(1);
                            }
                        };
                        reader.onerror = () => resolve(1);
                        reader.readAsArrayBuffer(file);
                    } else {
                        // For other file types (.doc, .ppt, .pptx), estimate based on file size
                        const fileSizeKB = file.size / 1024;
                        let estimatedPages;
                        
                        if (fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) {
                            // PowerPoint presentations - estimate 1 page per 50KB
                            estimatedPages = Math.max(1, Math.ceil(fileSizeKB / 50));
                        } else {
                            // Word documents - estimate 1 page per 20KB
                            estimatedPages = Math.max(1, Math.ceil(fileSizeKB / 20));
                        }
                        
                        resolve(estimatedPages);
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    resolve(1);
                }
            });
        }

        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'pdf':
                    return 'fa-file-pdf';
                case 'doc':
                case 'docx':
                    return 'fa-file-word';
                case 'ppt':
                case 'pptx':
                    return 'fa-file-powerpoint';
                default:
                    return 'fa-file';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'error' ? 'fa-exclamation-circle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 
                         type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 5 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>